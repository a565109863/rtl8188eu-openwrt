From 13f313905941ccd24c323e26a25f7aa52dd9a5e6 Mon Sep 17 00:00:00 2001
From: zjq <jingqin.zhong@zhice.ai>
Date: Wed, 4 Feb 2026 19:44:37 +0800
Subject: [PATCH] 0002-New-kernel-fixes.patch

---
 core/efuse/rtw_efuse.c            |  3 ++-
 core/rtw_mlme_ext.c               |  9 +++++----
 core/rtw_recv.c                   |  2 ++
 core/rtw_rf.c                     |  6 +++---
 core/rtw_sta_mgt.c                |  3 +--
 hal/hal_hci/hal_usb.c             |  9 ++++++++-
 hal/hal_intf.c                    |  3 ++-
 hal/led/hal_led.c                 |  2 +-
 hal/phydm/halrf/halrf.c           |  9 ++++-----
 hal/phydm/halrf/halrf_debug.c     |  6 +++---
 hal/rtl8188e/usb/rtl8188eu_xmit.c |  8 +++++++-
 os_dep/linux/ioctl_cfg80211.c     | 13 ++++++++-----
 os_dep/linux/os_intfs.c           |  4 ++--
 os_dep/linux/recv_linux.c         |  3 ++-
 14 files changed, 50 insertions(+), 30 deletions(-)

diff --git a/core/efuse/rtw_efuse.c b/core/efuse/rtw_efuse.c
index 613e91d..1f6cd63 100644
--- a/core/efuse/rtw_efuse.c
+++ b/core/efuse/rtw_efuse.c
@@ -968,8 +968,9 @@ void rtw_efuse_analyze(PADAPTER	padapter, u8 Type, u8 Fake)
 	j = 0;
 
 	for (i = 0; i < mapLen; i++) {
-		if (i % 16 == 0)
+		if (i % 16 == 0) {
 			RTW_PRINT_SEL(RTW_DBGDUMP, "0x%03x: ", i);
+		}
 			_RTW_PRINT_SEL(RTW_DBGDUMP, "%02X%s"
 				, pEfuseHal->fakeEfuseInitMap[i]
 				, ((i + 1) % 16 == 0) ? "\n" : (((i + 1) % 8 == 0) ? "	  " : " ")
diff --git a/core/rtw_mlme_ext.c b/core/rtw_mlme_ext.c
index 9e5cd0f..5b06c85 100644
--- a/core/rtw_mlme_ext.c
+++ b/core/rtw_mlme_ext.c
@@ -16,6 +16,7 @@
 
 #include <drv_types.h>
 #include <hal_data.h>
+#include <linux/compiler_attributes.h>
 
 struct mlme_handler mlme_sta_tbl[] = {
 	{WIFI_ASSOCREQ,		"OnAssocReq",	&OnAssocReq},
@@ -198,9 +199,9 @@ void rtw_txpwr_init_regd(struct rf_ctl_t *rfctl)
 	if (exc) {
 		u8 has_country = (exc->country[0] == '\0' && exc->country[1] == '\0') ? 0 : 1;
 
-		if (strcmp(exc->regd_name, regd_str(TXPWR_LMT_NONE)) == 0)
+		if (strscpy(exc->regd_name, regd_str(TXPWR_LMT_NONE)) == 0)
 			rfctl->regd_name = regd_str(TXPWR_LMT_NONE);
-		else if (strcmp(exc->regd_name, regd_str(TXPWR_LMT_WW)) == 0)
+		else if (strscpy(exc->regd_name, regd_str(TXPWR_LMT_WW)) == 0)
 			rfctl->regd_name = regd_str(TXPWR_LMT_WW);
 		else {
 			ent = _rtw_txpwr_lmt_get_by_name(rfctl, exc->regd_name);
@@ -298,7 +299,7 @@ void rtw_txpwr_init_regd(struct rf_ctl_t *rfctl)
 		);
 		if (rfctl->regd_name)
 			break;
-		/* fall through */
+		fallthrough;
 	default:
 		rfctl->regd_name = regd_str(TXPWR_LMT_WW);
 		RTW_PRINT("assign %s for default case\n", regd_str(TXPWR_LMT_WW));
@@ -1673,7 +1674,7 @@ void mgt_dispatcher(_adapter *padapter, union recv_frame *precv_frame)
 			ptable->func = &OnAuth;
 		else
 			ptable->func = &OnAuthClient;
-	/* fall through */
+		fallthrough;
 	case WIFI_ASSOCREQ:
 	case WIFI_REASSOCREQ:
 		_mgt_dispatcher(padapter, ptable, precv_frame);
diff --git a/core/rtw_recv.c b/core/rtw_recv.c
index 90f27ac..e72e79d 100644
--- a/core/rtw_recv.c
+++ b/core/rtw_recv.c
@@ -3833,8 +3833,10 @@ int validate_mp_recv_frame(_adapter *adapter, union recv_frame *precv_frame)
 			RTW_INFO("############ type:0x%02x subtype:0x%02x #################\n", type, subtype);
 
 			for (i = 0; i < precv_frame->u.hdr.len; i = i + 8)
+			{
 				RTW_INFO("%02X:%02X:%02X:%02X:%02X:%02X:%02X:%02X:\n", *(ptr + i),
 					*(ptr + i + 1), *(ptr + i + 2) , *(ptr + i + 3) , *(ptr + i + 4), *(ptr + i + 5), *(ptr + i + 6), *(ptr + i + 7));
+			}
 				RTW_INFO("#############################\n");
 				_rtw_memset(pmppriv->mplink_buf, '\0' , sizeof(pmppriv->mplink_buf));
 				_rtw_memcpy(pmppriv->mplink_buf, ptr, precv_frame->u.hdr.len);
diff --git a/core/rtw_rf.c b/core/rtw_rf.c
index 60c95c7..b568fcf 100644
--- a/core/rtw_rf.c
+++ b/core/rtw_rf.c
@@ -1979,7 +1979,7 @@ void dump_txpwr_lmt(void *sel, _adapter *adapter)
 
 						sprintf(fmt, "%%%zus%%s ", strlen(ent->regd_name) >= 6 ? 1 : 6 - strlen(ent->regd_name));
 						snprintf(tmp_str, TMP_STR_LEN, fmt
-							, strcmp(ent->regd_name, rfctl->regd_name) == 0 ? "*" : ""
+							, strscpy(ent->regd_name, rfctl->regd_name) == 0 ? "*" : ""
 							, ent->regd_name);
 						_RTW_PRINT_SEL(sel, "%s", tmp_str);
 					}
@@ -2000,7 +2000,7 @@ void dump_txpwr_lmt(void *sel, _adapter *adapter)
 							ent = LIST_CONTAINOR(cur, struct txpwr_lmt_ent, list);
 							cur = get_next(cur);
 							_RTW_PRINT_SEL(sel, "%3c "
-								, strcmp(ent->regd_name, rfctl->regd_name) == 0 ? rf_path_char(path) : ' ');
+								, strscpy(ent->regd_name, rfctl->regd_name) == 0 ? rf_path_char(path) : ' ');
 						}
 						_RTW_PRINT_SEL(sel, "%3c "
 								, strcmp(rfctl->regd_name, regd_str(TXPWR_LMT_WW)) == 0 ? rf_path_char(path) : ' ');
@@ -2212,7 +2212,7 @@ struct txpwr_lmt_ent *_rtw_txpwr_lmt_get_by_name(struct rf_ctl_t *rfctl, const c
 		ent = LIST_CONTAINOR(cur, struct txpwr_lmt_ent, list);
 		cur = get_next(cur);
 
-		if (strcmp(ent->regd_name, regd_name) == 0) {
+		if (strscpy(ent->regd_name, regd_name) == 0) {
 			found = 1;
 			break;
 		}
diff --git a/core/rtw_sta_mgt.c b/core/rtw_sta_mgt.c
index c2e27b9..4f5b689 100644
--- a/core/rtw_sta_mgt.c
+++ b/core/rtw_sta_mgt.c
@@ -388,8 +388,7 @@ void rtw_mfree_stainfo(struct sta_info *psta);
 void rtw_mfree_stainfo(struct sta_info *psta)
 {
 
-	if (&psta->lock != NULL)
-		_rtw_spinlock_free(&psta->lock);
+	_rtw_spinlock_free(&psta->lock);
 
 	_rtw_free_sta_xmit_priv_lock(&psta->sta_xmitpriv);
 	_rtw_free_sta_recv_priv_lock(&psta->sta_recvpriv);
diff --git a/hal/hal_hci/hal_usb.c b/hal/hal_hci/hal_usb.c
index 609616b..78508b5 100644
--- a/hal/hal_hci/hal_usb.c
+++ b/hal/hal_hci/hal_usb.c
@@ -17,6 +17,13 @@
 #include <drv_types.h>
 #include <hal_data.h>
 
+#ifdef PLATFORM_LINUX
+static void usb_recv_tasklet_wrapper(unsigned long data)
+{
+	usb_recv_tasklet((void *)data);
+}
+#endif
+
 int	usb_init_recv_priv(_adapter *padapter, u16 ini_in_buf_sz)
 {
 	struct registry_priv *regsty = adapter_to_regsty(padapter);
@@ -26,7 +33,7 @@ int	usb_init_recv_priv(_adapter *padapter, u16 ini_in_buf_sz)
 
 #ifdef PLATFORM_LINUX
 	tasklet_init(&precvpriv->recv_tasklet,
-		     (void(*)(unsigned long))usb_recv_tasklet,
+		     usb_recv_tasklet_wrapper,
 		     (unsigned long)padapter);
 #endif /* PLATFORM_LINUX */
 
diff --git a/hal/hal_intf.c b/hal/hal_intf.c
index a6eb51e..d232556 100644
--- a/hal/hal_intf.c
+++ b/hal/hal_intf.c
@@ -17,6 +17,7 @@
 
 #include <drv_types.h>
 #include <hal_data.h>
+#include <linux/compiler_attributes.h>
 
 const u32 _chip_type_to_odm_ic_type[] = {
 	0,
@@ -1369,7 +1370,7 @@ s32 c2h_handler(_adapter *adapter, u8 id, u8 seq, u8 plen, u8 *payload)
 	case C2H_EXTEND:
 		sub_id = payload[0];
 		/* no handle, goto default */
-		/* fall through */
+		fallthrough;
 
 	default:
 		if (phydm_c2H_content_parsing(adapter_to_phydm(adapter), id, plen, payload) != TRUE)
diff --git a/hal/led/hal_led.c b/hal/led/hal_led.c
index 95d3daa..2a753f9 100644
--- a/hal/led/hal_led.c
+++ b/hal/led/hal_led.c
@@ -63,7 +63,7 @@ void rtw_led_set_strategy(_adapter *adapter, u8 strategy)
 	rtw_hal_sw_led_deinit(pri_adapter);
 #endif
 
-	rtw_led_control(pri_adapter, RTW_LED_OFF);
+	rtw_led_control(pri_adapter, LED_CTL_POWER_OFF);
 }
 
 #ifdef CONFIG_RTW_SW_LED
diff --git a/hal/phydm/halrf/halrf.c b/hal/phydm/halrf/halrf.c
index e9b30ca..22acc5c 100644
--- a/hal/phydm/halrf/halrf.c
+++ b/hal/phydm/halrf/halrf.c
@@ -820,7 +820,7 @@ void halrf_support_ability_debug(void *dm_void, char input[][16], u32 *_used,
 	u8 i;
 
 	for (i = 0; i < 5; i++)
-		if (input[i + 1])
+		if (*input[i + 1])
 			PHYDM_SSCANF(input[i + 2], DCMD_DECIMAL, &dm_value[i]);
 
 	if (dm_value[0] == 100) {
@@ -895,7 +895,7 @@ void halrf_support_band_shift_debug(void *dm_void, char input[][16], u32 *_used,
 
 #if (RTL8192F_SUPPORT == 1)
 	for (i = 0; i < 7; i++)
-		if (input[i + 1])
+		if (*input[i + 1])
 			PHYDM_SSCANF(input[i + 2], DCMD_DECIMAL, &dm_value[i]);
 
 	if (!(rf->rf_supportability & HAL_2GBAND_SHIFT)) {
@@ -949,12 +949,11 @@ void halrf_cmn_info_init(void *dm_void, enum halrf_cmninfo_init cmn_info,
 	}
 }
 
-void halrf_cmn_info_hook(void *dm_void, u32 u_cmn_info,
+void halrf_cmn_info_hook(void *dm_void, enum halrf_cmninfo_hook cmn_info,
 			 void *value)
 {
 	struct dm_struct *dm = (struct dm_struct *)dm_void;
 	struct _hal_rf_ *rf = &dm->rf_table;
-	enum halrf_cmninfo_hook cmn_info = (enum halrf_cmninfo_hook)u_cmn_info;
 
 	switch (cmn_info) {
 	case HALRF_CMNINFO_CON_TX:
@@ -4119,7 +4118,7 @@ void halrf_dump_rfk_reg(void *dm_void, char input[][16], u32 *_used,
 
 	reg_1b00 = odm_get_bb_reg(dm, R_0x1b00, MASKDWORD);
 
-	if (input[2])
+	if (*input[2])
 		PHYDM_SSCANF(input[2], DCMD_DECIMAL, &var1[0]);
 
 	if ((strcmp(input[2], help) == 0))
diff --git a/hal/phydm/halrf/halrf_debug.c b/hal/phydm/halrf/halrf_debug.c
index 3f2d142..41fc291 100644
--- a/hal/phydm/halrf/halrf_debug.c
+++ b/hal/phydm/halrf/halrf_debug.c
@@ -151,7 +151,7 @@ void halrf_debug_trace(void *dm_void, char input[][16], u32 *_used,
 	u8 i;
 
 	for (i = 0; i < 5; i++)
-		if (input[i + 1])
+		if (*input[i + 1])
 			PHYDM_SSCANF(input[i + 2], DCMD_DECIMAL, &rf_var[i]);
 
 	if (rf_var[0] == 100) {
@@ -211,7 +211,7 @@ void halrf_dack_debug_cmd(void *dm_void, char input[][16])
 	u8 i;
 
 	for (i = 0; i < 7; i++)
-		if (input[i + 1])
+		if (*input[i + 1])
 			PHYDM_SSCANF(input[i + 2], DCMD_DECIMAL, &dm_value[i]);
 
 	if (dm_value[0] == 1)
@@ -329,7 +329,7 @@ void halrf_cmd_parser(void *dm_void, char input[][16], u32 *_used, char *output,
 		PDM_SNPF(out_len, used, output + used, out_len - used,
 			 "IQK DEBUG!!!!!\n");
 		for (i = 0; i < 5; i++) {
-			if (input[i + 1]) {
+			if (*input[i + 1]) {
 				PHYDM_SSCANF(input[i + 2], DCMD_HEX,
 					     &rf_var[i]);
 				input_idx++;
diff --git a/hal/rtl8188e/usb/rtl8188eu_xmit.c b/hal/rtl8188e/usb/rtl8188eu_xmit.c
index 8d8fe77..852ba13 100644
--- a/hal/rtl8188e/usb/rtl8188eu_xmit.c
+++ b/hal/rtl8188e/usb/rtl8188eu_xmit.c
@@ -17,6 +17,12 @@
 #include <drv_types.h>
 #include <rtl8188e_hal.h>
 
+#ifdef PLATFORM_LINUX
+static void rtl8188eu_xmit_tasklet_wrapper(unsigned long data)
+{
+	rtl8188eu_xmit_tasklet((void *)data);
+}
+#endif
 
 s32	rtl8188eu_init_xmit_priv(_adapter *padapter)
 {
@@ -25,7 +31,7 @@ s32	rtl8188eu_init_xmit_priv(_adapter *padapter)
 
 #ifdef PLATFORM_LINUX
 	tasklet_init(&pxmitpriv->xmit_tasklet,
-		     (void(*)(unsigned long))rtl8188eu_xmit_tasklet,
+		     rtl8188eu_xmit_tasklet_wrapper,
 		     (unsigned long)padapter);
 #endif
 #ifdef CONFIG_TX_EARLY_MODE
diff --git a/os_dep/linux/ioctl_cfg80211.c b/os_dep/linux/ioctl_cfg80211.c
index cbb4042..0858bb0 100644
--- a/os_dep/linux/ioctl_cfg80211.c
+++ b/os_dep/linux/ioctl_cfg80211.c
@@ -16,6 +16,7 @@
 
 #include <drv_types.h>
 #include <hal_data.h>
+#include <linux/compiler_attributes.h>
 
 #ifdef CONFIG_IOCTL_CFG80211
 
@@ -456,7 +457,7 @@ u8 rtw_cfg80211_ch_switch_notify(_adapter *adapter, u8 ch, u8 bw, u8 offset,
 	if (started) {
 #if LINUX_VERSION_CODE < KERNEL_VERSION(5, 19, 2)
 	cfg80211_ch_switch_notify(adapter->pnetdev, &chdef);
-#elif LINUX_VERSION_CODE >= KERNEL_VERSION(6, 9, 0)
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(6, 6, 0)
 	cfg80211_ch_switch_started_notify(adapter->pnetdev, &chdef, 0, 0, false);	
 #elif LINUX_VERSION_CODE >= KERNEL_VERSION(6, 3, 0)
 	cfg80211_ch_switch_started_notify(adapter->pnetdev, &chdef, 0, 0, false, 0);
@@ -473,7 +474,7 @@ u8 rtw_cfg80211_ch_switch_notify(_adapter *adapter, u8 ch, u8 bw, u8 offset,
 		goto exit;
 	#if (LINUX_VERSION_CODE < KERNEL_VERSION(5, 19, 0))
 	cfg80211_ch_switch_notify(adapter->pnetdev, &chdef);
-	#elif (LINUX_VERSION_CODE < KERNEL_VERSION(6, 3, 0) || (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 9, 0)))
+	#elif (LINUX_VERSION_CODE < KERNEL_VERSION(6, 3, 0) || (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 6, 0)))
 	cfg80211_ch_switch_notify(adapter->pnetdev, &chdef, 0);
 	#else
   	cfg80211_ch_switch_notify(adapter->pnetdev, &chdef, 0, 0);
@@ -5391,6 +5392,7 @@ exit:
 	return ret;
 }
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(6, 6, 0))
 static int cfg80211_rtw_change_beacon(struct wiphy *wiphy, struct net_device *ndev,
 		struct cfg80211_beacon_data *info)
 {
@@ -5403,6 +5405,7 @@ static int cfg80211_rtw_change_beacon(struct wiphy *wiphy, struct net_device *nd
 
 	return ret;
 }
+#endif
 #if (LINUX_VERSION_CODE < KERNEL_VERSION(5, 19, 0))
 static int cfg80211_rtw_stop_ap(struct wiphy *wiphy, struct net_device *ndev)
 #else
@@ -6826,7 +6829,7 @@ static void rtw_get_chbwoff_from_cfg80211_chan_def(
 	switch (chandef->width) {
 	case NL80211_CHAN_WIDTH_20_NOHT:
 		*ht = 0;
-		/* fall through */
+		fallthrough;
 	case NL80211_CHAN_WIDTH_20:
 		*bw = CHANNEL_WIDTH_20;
 		*offset = HAL_PRIME_CHNL_OFFSET_DONT_CARE;
@@ -6872,7 +6875,7 @@ static void rtw_get_chbwoff_from_cfg80211_chan_def(
 #endif /* (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 8, 0)) */
 
 static int cfg80211_rtw_set_monitor_channel(struct wiphy *wiphy
-#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 13, 0))
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 6, 0))
 	, struct net_device *dev
 #endif
 	#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 8, 0))
@@ -10444,7 +10447,7 @@ static struct cfg80211_ops rtw_cfg80211_ops = {
 	.del_beacon = cfg80211_rtw_del_beacon,
 #else
 	.start_ap = cfg80211_rtw_start_ap,
-	#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 7, 0))
+	#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 6, 0))
 	#else
 	.change_beacon = cfg80211_rtw_change_beacon,
 	#endif
diff --git a/os_dep/linux/os_intfs.c b/os_dep/linux/os_intfs.c
index 390d001..b3263ce 100644
--- a/os_dep/linux/os_intfs.c
+++ b/os_dep/linux/os_intfs.c
@@ -1624,7 +1624,7 @@ static int rtw_net_set_mac_address(struct net_device *pnetdev, void *addr)
 	}
 
 	_rtw_memcpy(adapter_mac_addr(padapter), sa->sa_data, ETH_ALEN); /* set mac addr to adapter */
-	_rtw_memcpy(pnetdev->dev_addr, sa->sa_data, ETH_ALEN); /* set mac addr to net_device */
+	_rtw_memcpy((void *)pnetdev->dev_addr, sa->sa_data, ETH_ALEN); /* set mac addr to net_device */
 
 #if 0
 	if (rtw_is_hw_init_completed(padapter)) {
@@ -2164,7 +2164,7 @@ int rtw_os_ndev_register(_adapter *adapter, const char *name)
 	/* alloc netdev name */
 	rtw_init_netdev_name(ndev, name);
 
-	_rtw_memcpy(ndev->dev_addr, adapter_mac_addr(adapter), ETH_ALEN);
+	_rtw_memcpy((void *)ndev->dev_addr, adapter_mac_addr(adapter), ETH_ALEN);
 
 	/* Tell the network stack we exist */
 
diff --git a/os_dep/linux/recv_linux.c b/os_dep/linux/recv_linux.c
index 13cd766..652a788 100644
--- a/os_dep/linux/recv_linux.c
+++ b/os_dep/linux/recv_linux.c
@@ -413,8 +413,9 @@ static int napi_recv(_adapter *padapter, int budget)
 
 		if (rtw_netif_receive_skb(padapter->pnetdev, pskb) == NET_RX_SUCCESS)
 			rx_ok = _TRUE;
-
+#ifdef CONFIG_RTW_GRO
 next:
+#endif
 		if (rx_ok == _TRUE) {
 			work_done++;
 			DBG_COUNTER(padapter->rx_logs.os_netif_ok);
-- 
2.39.3 (Apple Git-145)

